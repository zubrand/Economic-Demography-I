---
title: "Demographic Analysis of Norway"
subtitle: "Economic Demography I Assignment "
author: "Andriy Zhubryd"
date: "15. Äervna 2016"
output: 
  html_document:
    code_folding: hide
    fig_width: 8
    keep_md: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

```{r setup, echo=FALSE}
library(dplyr, warn.conflicts = F)      # Work with datasets: filter, group, summarize
library(reshape2)   # Transformation of datasets: wide-to-long format and vice versa
library(pyramid)    # Visualization of demography pyramid
library(ggplot2)    # Building graphs
library(scales)     # Number formatting
```

```{r load_data, message=FALSE, warning=FALSE, include=FALSE}
load("D:/OneDrive/VSE/II/Economic Demography I/Project Norway/Data/Eurostat.RData")
```

# Introduction

This paper is focused on analysing Norway's population and its changes in time. The following main areas will be covered in this paper:

* Population size and structure

* Fertility

* Mortality

* Migration

* Marriages, divorces

* Education

* Life tables

* Population projections

All analyses are based on data from [Eurostat](http://ec.europa.eu/eurostat/web/population-demography-migration-projections/overview)
and are performed in R. 

Code parts are available in this report in the collapsed form and they can be explored by user. Some code elements are explained in the Appendix. Also, raw data description and samples are provided in the Appendix.



# Population size and structure
## Population size in time

First of all, we should look at the population size and its development in time. Here are plots and table showing Norway's population in time:

```{r pop_size, fig.align='center', fig.width=8}
dt_Population_Age_Sex %>% 
  group_by(Year) %>% summarize(Population = sum(Population, na.rm = T)) %>%
  ggplot(aes(x = Year, y = Population)) + geom_point(size = 2) +
    geom_line() + scale_y_continuous(limits = c(0, 6*10^6), labels = comma) +
    ggtitle("Development of Norway's population in time")

dt_Population_Age_Sex %>% 
  group_by(Year, Sex) %>% summarize(Population = sum(Population, na.rm = T)) %>%
  ggplot(aes(x = Year, y = Population, color = Sex)) + geom_point(size = 2) +
  geom_line() + scale_y_continuous(limits = c(0, 3*10^6), labels = comma) +
  ggtitle("Development of Norway's population in time by sex")

dt_Population_Age_Sex %>%
  group_by(Year, Sex) %>% summarize(Population = sum(Population, na.rm = T)) %>%
  dcast(Year ~ Sex, fun.aggregate = sum, value.var = "Population") %>%
  mutate(Total = M + F) %>% filter(Year >= 2000) %>% 
  mutate(Total = comma(Total) , M = comma(M), F = comma(F))
```

As we can see from the graph, population is steadily growing: approximately `45%` in `55` years, which makes up for `0.67%` increase per annum. In 1960 population comprised around `3.5` mln people and as of 2015 it's nearly `5.2` mln people. 

Also, we can see from the second graph that number of males and females is nearly the same throught the history. More detailed analysis of this will be in the following section.

## Population age structure

Best way to analyze population strucure is to start with the age-sex pyramid graph. Pyramid graph stores the nation's history and to confirm that we will build graphs for different years: 1960, 1980, 2000 and 2013.


```{r pyramids, fig.align='center', fig.width=8, fig.height=6}

dt_Population_Age_Sex %>% 
  filter(Year == 1960) %>% group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = 1, Cstep = 5, AxisFM = 'd', Cgap = .1, Laxis = 10^4 * 0:4,
          main = "Pyramid of Norway's population in 1960")

dt_Population_Age_Sex %>% 
  filter(Year == 1980) %>% group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = 1, Cstep = 5, AxisFM = 'd', Cgap = .1, Laxis = 10^4 * 0:4,
          main = "Pyramid of Norway's population in 1980")

dt_Population_Age_Sex %>% 
  filter(Year == 2000) %>% group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = 1, Cstep = 5, AxisFM = 'd', Cgap = .1, Laxis = 10^4 * 0:4,
          main = "Pyramid of Norway's population in 2000")

dt_Population_Age_Sex %>% 
  filter(Year == 2013) %>% group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = 1, Cstep = 5, AxisFM = 'd', Cgap = .1, Laxis = 10^4 * 0:4,
          main = "Pyramid of Norway's population in 2013")
```

From the pyramid graphs you can see that peaks and gaps of generations are transferring to the further years. Pyramid is actually moving up with time.

We can notice that population was between progressive and stationary in 1960 with significant share of young generation. Currently (2013), we can say that population moved more to the regressive type with more or less stabel distribution of population up to age of 70. This kind of transformation is the natural process due to development of country and living conditions.

In addition, let's show the change of index of masculinity (proportion of males to females) with the age increase:

```{r age_proportion, fig.align='center', fig.width=8, fig.height=5}
dt_Population_Age_Sex %>%
  filter(Year %in% c(1960, 1980, 2000, 2013)) %>% group_by(Year, Age, Sex) %>%
  summarize(value = sum(Population, na.rm = T)) %>% 
  dcast(Year + Age ~ Sex, fun.aggregate = sum, value.var = "value") %>%
  mutate(Index.of.Masculinity = M/F, Year = factor(Year)) %>%
  ggplot(aes(x = Age, y = Index.of.Masculinity, color = Year)) + 
  geom_line() + geom_hline(yintercept = 1, size = .2) + 
  ggtitle("Development of Index of Masculinity with Age\nNorway") +
  scale_x_continuous(breaks = 20*0:5, labels = 20*0:5)
  
```

From this graph we can make the following conclusions:

1. There are more males at the younger age
2. Proportion of males to females is decreasing with age
3. Parity point's age (equal number of males and females) is increasing with time: from nearly 40 in 1960 to 58 in 2000 and 65 in 2013

This means that mortality rate for males is higher, but it's decreasing in time quicker than for females.

## Generations
### Biological Generations

Biological generations are:

* children (0-14 years)
* parents (15-49 years)
* grandparents (50+ years)

Here's the graph of development of biological generations in time and detail information about biological generations in 2013:

```{r bio, fig.align='center', fig.width=8, fig.height=5}
tmp_Population_Age_Sex_Gen <- dt_Population_Age_Sex %>% 
  mutate(Gen_bio = cut(Age, include.lowest = T, breaks = c(0, 15, 50, 100), right = F),
         Gen_eco = cut(Age, include.lowest = T, breaks = c(0, 20, 65, 100), right = F))

tmp_Bio_Generation <- tmp_Population_Age_Sex_Gen %>%
  group_by(Year, Generation = Gen_bio) %>% summarize(Value = sum(Population, na.rm = T)) %>%
  merge(dt_Population_Age_Sex %>% group_by(Year) %>% summarize(pop = sum(Population, na.rm = T)), by = "Year") %>%
  mutate(Share = Value/pop) %>% select(Year, Generation, Share)

tmp_Bio_Generation %>% 
  ggplot(aes(x = Year, y = Share, color = Generation, fill = Generation)) +
    geom_area() + ggtitle("Development of Biological generations in Time\nNorway")

tmp_Bio_Generation %>% filter(Year == 2013) %>%
  ggplot(aes(x = "", y = Share, fill = Generation)) +
    geom_bar(width = 1, stat = "identity") + coord_polar(theta = "y", start = 0) + 
    ggtitle("Norwish population by Biological generations in 2013")

tmp_Bio_Generation %>% filter(Year == 2013) %>% mutate(Share = round(Share*100, digits = 1))
```

From the graphs we see that:

* Share of younger generation is constantly decreasing from `25%` in 1960 to `18.4%` in 2013
* In the meanwhile, share of older generation is increasing with approximately the same speed, which is causing steady upward trend of Sauvy's index (shown later)
* Medium generation (parents) is more or less constant in time and volatiles around ``r (100*tmp_Bio_Generation$Share[tmp_Bio_Generation$Generation == "[15,50)"]) %>% mean() %>% round(2) %>% paste("%", sep = "")`` of population

We can conclude from these numbers that Norway moved from stationary type of population in 1960 to regressive one.

### Economical generations

Same transformations we'll perform for economical generations with slighly different age ranges:

* pre-productive (0-19 years)
* productive (20-64 years)
* post-productive (65+ years)

Development in time of shares of economical generations is shown below:

```{r eco, fig.align='center'}
tmp_Eco_Generation <- tmp_Population_Age_Sex_Gen %>%
  group_by(Year, Generation = Gen_eco) %>% summarize(Value = sum(Population, na.rm = T)) %>%
  merge(dt_Population_Age_Sex %>% group_by(Year) %>% summarize(pop = sum(Population, na.rm = T)), by = "Year") %>%
  mutate(Share = Value/pop) %>% select(Year, Generation, Share)

tmp_Eco_Generation %>% 
  ggplot(aes(x = Year, y = Share, color = Generation, fill = Generation)) +
  geom_area() + ggtitle("Development of Economical generations in Time\nNorway")

tmp_Eco_Generation %>% filter(Year == 2013) %>%
  ggplot(aes(x = "", y = Share, fill = Generation)) +
  geom_bar(width = 1, stat = "identity") + coord_polar(theta = "y", start = 0) + 
  ggtitle("Norwish population by Economical generations in 2013")

tmp_Eco_Generation %>% filter(Year == 2013) %>% mutate(Share = round(Share*100, digits = 1))       

```

Similarly to biological generation, we see that:

* Share of pre-productive generation is constantly decreasing from, while share of post-productive is increasing with approximately the same speed. This is causing constant increase of ratio of seniority
* Productive generation is more or less constant in time with slight upward trend and average ``r (100*tmp_Eco_Generation$Share[tmp_Eco_Generation$Generation == "[20,65)"]) %>% mean() %>% round(0) %>% paste("%", sep = "")`` of population during last 55 years. 

This means that total dependency ratio is slightly decreasing in time, mostly due to decrease of young-age dependency ratio.

### Indicators

Now we will calculate all the indicators, which are applicable to biological and economical generations and interpret their meaning. Also, we will show development of those indicators in time:

```{r indicators, fig.align='center'}
Ratios <- tmp_Population_Age_Sex_Gen %>% #filter (Year >= 2000) %>% 
    dcast(Year ~ Sex, value.var = "Population", fun.aggregate = sum, na.rm = T) %>%
    mutate(Im = M/F, If = F/M) %>% select(Year, Im, If)

Ratios <- tmp_Bio_Generation %>% #filter(Year >= 2000) %>%
    dcast(Year ~ Generation, value.var = "Share", fun.aggregate = sum, na.rm = T) %>%
    setNames(c("Year", "I", "II","III")) %>% return %>%
    mutate(Sauvy = III/I) %>% select(Year, Sauvy) %>% merge(Ratios, by = "Year")

Ratios <- tmp_Eco_Generation %>% #filter(Year >= 2000) %>%
  dcast(Year ~ Generation, value.var = "Share", fun.aggregate = sum, na.rm = T) %>%
  setNames(c("Year", "I", "II","III")) %>% return %>%
  mutate(TDR = (I+III)/II, OADR = III/II, JADR = I/II, Seniority = III/I) %>% 
  select(-I,-II,-III) %>% merge(Ratios, by = "Year")

Ratios %>% filter((Year %% 10 == 0) | Year > 2000) %>% melt(id = c("Year")) %>%
  mutate(value = round(value, 3)) %>% dcast(Year ~ variable)
## Development of ratios in time
# Masculinity index
Ratios %>% select(Year, Im, If) %>% melt(id = "Year") %>%
  setNames(c("Year", "Index", "Value")) %>% return %>%
  ggplot(aes(x = Year, y = Value, color = Index)) + geom_point() + geom_line() +
  ylim(c(0.9,1.1)) + ggtitle("Development of masculinity index in time\nGermany") +
  geom_vline(xintercept = 2011, size = 0.5, linetype = "longdash")

# Sauvy
ggplot(Ratios, aes(x = Year, y = Sauvy)) + geom_point() + geom_line() +
  ggtitle("Development of Sauvy index in time\nNorway") + ylim(c(0,2))

# Economical generations
Ratios %>% select(Year, TDR, OADR, JADR, Seniority) %>% melt(id = "Year") %>%
  setNames(c("Year", "Index", "Value")) %>% return %>%
  ggplot(aes(x = Year, y = Value, color = Index)) + geom_point() + geom_line() +
  ylim(0:1) + ggtitle("Development of indeces of economical generations in time\nNorway")

```

Conclusions from three graphs and table above:

1. For the period of 1960-2000 number of females was higher than males and this proportion was increasing. After 2000 started falling and in 2011 there was nearly equal amount of males and female in Norway. Since then, proportion was in favor of males with steady increasing trend.

2. Sauvy's index can be simply interpreted as number of grandparents per one child. It increased from `1.07` in 1960 to `1.9` in 2015, which confirms our previous statement about Norway transforming from stationary type of population into regressive one. Value of `1.9` is still quite reasonable and healthy for the country.

3. Total dependency ratio was slowly decreasing from `0.78` to `0.68`, which is mostly due to significant fall of young-age dependency ratio (from `0.59` to `0.41`). This level was always in the safe zone - below threshold value of `1`. Index of seniority is behaving in the similar manner to the Sauvy's index, which is expected.




## Education

Education is an indicator of qualitative development of population of the country. We will look at the distribution of population by reached educational level by age and sex. Also, we'll look how this distribution was changing in time:

```{r education, fig.align='center'}
tmp_Education <- dt_Education %>% group_by(Age, Sex, Year) %>% summarize(Pop = sum(Count)) %>% 
  merge(dt_Education) %>% mutate(Share = 100 * Count / Pop)

tmp_Education$Education <- tmp_Education$Education %>% 
  factor(levels(tmp_Education$Education)[c(2,4,1,5,3)], ordered = T)

tmp_Education %>%
  filter(Year %in% c(2007, 2014) & Age >= 15) %>% 
  mutate(Year = factor(Year), `Age Group` = Age - Age %% 5) %>%
  group_by(Year, `Age Group`, Education, Sex) %>% summarise(Share = 100*sum(Count)/sum(Pop)) %>% 
  ggplot(aes(x = `Age Group`, y = Share, color = Education, fill = Education)) +
  geom_area() + facet_grid(Sex ~ Year) + 
  ggtitle("Educational structure of Norway by sex and 5-year age groups") +
  theme(legend.position = "bottom", legend.direction="horizontal")
```

Education is quite a specific indicator because, similarly to population pyramid, it stores nation's memory. Highest level of education is usually reached at 20-25 years, which means that people in 2014 of age 60 represent cohort that was receiving their education (highest level) at 1974-1979. This kind of memory allows us to estimate historical distribution of 20-25 year-old population by education.

Unfortunately, this estimate strongly depends on 2 elements of population change: death rate and migration rate. For our estimate to be true, there should be no correlation between person's educational level and both death rate and migration. In case of death rate such an assumption can be viable, but for migration it seems unprobable. First of all, people with higher level of education have more opportunities to emigrate, while people with lower education are more grounded. Secondly, with the latest trends in European education, significant part of immigration is either already with tertiary education or is moving to European countries such as Norway to receive higher education (and then, maybe emigrate). Therefore, we see a peak (mode) in share of tretiary education at `25-35` age range and then steady decrease.

Regarding the difference between males and females: it seems that females have higher share of tertiary at the mode zone of `25-35`, but it is followed with much sharper decrease than for males and at the age `60-65` share tertiary education of females goes below the share for females.

Further, we will look at the development of education structure of age group `25-35` in time:

```{r education_time, fig.align='center'}
tmp_Education %>% 
  filter(Age >= 25 & Age <= 35) %>% 
  group_by(Sex, Year, Education) %>%
  summarize(Share = sum(Count)/sum(Pop) * 100) %>%
  ggplot(aes(x = Year, y = Share, color = Education, fill = Education)) +
  geom_area() + facet_grid(. ~ Sex) +
  theme(legend.position = "bottom", legend.direction="horizontal") +
  ggtitle("Development of education structure\nof Norway's population for age group 25-35")
```

We can notice a suspicious change in distribution from 2011 to 2012, which looks like `Unknown` catogory was partially identified and redistributed between other categories: tertiary for females, tertiary and upper secondary for males. If to neglect this jump, trends were the following:

* Share of lower secondary (also includes primary) education is mostly stable in time and higher for male population
* Share of upper secondary education is steadily decreasing and share for males is higher
* Share of tertiary education is increasing in time and it is significantly higher for females

Conclusions regarding educationcal structure of Norwish population:

1. Females are more educated than males
2. Steadily increasing trend of share of higher (tertiary) education in Norway
3. High migration of people, who receive higher (tertiary) education in Norway

## Marriages

Marriages and partnerships are a vital part of normal development of society. Unfortunately, according to the new trends it is not the main source of fertility (less than 50% or childbirths, details in section `Population change`).

Let's have a quick look at the general trends of marriage indicators in Norway:

```{r marriage_intro, fig.align='center'}
tmp_Marriage_General <- dt_Marriage_Age %>% 
  group_by(Year) %>% summarize(Marriages = sum(Count)) %>%
  merge(dt_Population_general %>% filter(Indicator == "Average population") %>% 
          group_by(Year) %>% summarize(Pop = sum(Value, na.rm = T))) %>%
  mutate(`Crude Marriage Rate` = Marriages/Pop*1000) %>% select(-Pop) %>%
  melt(id = "Year") %>% select(variable, Year, value) %>% 
  setNames(c("Indicator", "Year", "Value")) %>% rbind(dt_Divorce)

tmp_Marriage_General %>%
  dcast(Year ~ Indicator, value.var = "Value") %>%
  mutate(Marriages = comma(Marriages), 
         `Crude Marriage Rate` = round(`Crude Marriage Rate`, 2),
         Divorces = comma(Divorces))

tmp_Marriage_General %>%
  filter(Year >= 2007 & Indicator %in% c("Crude Marriage Rate", "Crude divorce rate")) %>%
  ggplot(aes(x = Year, y = Value, color = Indicator)) + geom_line() + geom_point() +
  ylab("Crude rate") + ggtitle("Development of marriage indicators in time in Norway") +
  scale_y_continuous(limits = c(0,8))
```

Crude marriage rate is showing decreasing trend, which may be an explanation to the increase of share of childbirths outside the marriage. Crude divorce rate is quite stable in time with slight decrease.

Now let's look in details on marriages' statistics:

```{r marriage_main, fig.align='center'}
dt_Marriage_Age %>% 
  filter(Year %in% c(2007, 2010, 2014)) %>% mutate(Year = factor(Year)) %>%
  ggplot(aes(x = Age %>% as.numeric(), y = Count, color = Year)) + 
  geom_line() + geom_point() + facet_grid(Sex ~ .) +
  theme(legend.position = "bottom", legend.direction="horizontal") +
  ggtitle("Distribution of number of marriages in Norway by age groups and sex") +
  ylab("Number of marriages") + xlab("Age Group") +
  scale_x_discrete(breaks = 1:8, labels = levels(dt_Marriage_Age$Age))

dt_Marriage_PrevStatus %>% filter(Year != 2007) %>%
  merge(dt_Marriage_PrevStatus %>% group_by(Sex, Year) %>% 
          summarize(Tot = sum(Count, na.rm = T)), by = c("Sex", "Year")) %>% 
  mutate(Share = Count/Tot*100) %>% arrange(MARSTA) %>%
  ggplot(aes(x = Year, y = Share, fill = MARSTA)) +
  geom_area() + facet_grid(. ~ Sex) + 
  theme(legend.position = "bottom", legend.direction="horizontal") +
  ggtitle("Structure by marital status of bride and groom in Norway")

dt_Marital %>% filter(Year %in% c(2000, 2015) & Age >= 15) %>%
  group_by(Age, Sex, Year) %>% summarize(Tot = sum(Count, na.rm = T)) %>%
  merge(dt_Marital) %>% arrange(Marsta) %>% 
  mutate(Share = 100*Count/Tot, Year = factor(Year),
         Marsta = factor(Marsta, levels(Marsta)[c(5,2,3,1,4,6)], ordered = T)) %>%
  ggplot(aes(x = Age, y = Share, fill = Marsta)) + geom_area() +
  facet_grid(Year ~ Sex) + theme(legend.position = "bottom", legend.direction="horizontal") +
  ggtitle("Structure of population of Norway by marital status") +
  scale_fill_brewer(palette = 2, type = "qual")

dt_Marital %>% filter(Age == 50) %>%
  group_by(Age, Sex, Year) %>% summarize(Tot = sum(Count, na.rm = T)) %>%
  merge(dt_Marital) %>% arrange(Marsta) %>% 
  mutate(Share = Count/Tot) %>%
  filter(Marsta == "Single") %>%
  ggplot(aes(x = Year, y = Share, color = Sex)) +
  geom_point() + geom_line() + ylim(c(0, 0.5)) +
  ggtitle("Share of Norwish population, which have not been\nmarried before age of 50")


cat("Average age of population groups by marital status")
dt_Marital %>% filter(Age >= 15 & Year == 2015) %>%
  group_by(Sex, Marsta) %>% 
  summarize(Average_Age = round(sum(Age * Count, na.rm = T)/sum(Count, na.rm = T),1)) %>%
  dcast(Marsta ~ Sex, value.var = "Average_Age")
```

Conclusions regarding marriages and marital structure of population in Norway:

1. Males tend to marry at later age than females: mode for males is `30-34`, while `25-29` for females
2. Males tend to re-marry more: share of divorced males in new marriages is higher than females; trend is slowly decreasing
3. Share of widowers in the old age is significantly higher for females, which can be explained by higher life expectancy for females
4. Current visible trend is to marry at later age: share of population, which have not been married before age of 50, had increased from `10%` to `25%` in last 15 years. For females this indicator is on the lower level


# Population change

After analyzing population size and structure, which is based on annual snapshots, it is a logical step to look at what is happenning with the population between those snapshots: births, deaths, migration.

Here's a general picture of those changes as percentage of the average population during the year:

```{r general_population, fig.align='center'}
tmp_Population_General <- dt_Population_general %>%
  filter(!(Indicator %in% c("Average population", "Population Start"))) %>%
  group_by(Indicator, Year) %>% summarize(Value = sum(Value, na.rm = T)) %>%
  merge(dt_Population_general %>% filter(Indicator == "Average population") %>% 
          group_by(Year) %>% summarize(Pop = sum(Value, na.rm = T)), by = "Year") %>%
  mutate(Value = round(Value/Pop*100, 3))

tmp_Population_General %>%
  dcast(Year ~ Indicator, fun.aggregate = sum, na.rm = T, value.var = "Value")

tmp_Population_General %>% 
  filter(!(Indicator %in% c("Net migration", "Total population change"))) %>%
  ggplot(aes(x = Year, y = Value, color = Indicator)) + geom_line() + geom_point() + ylim(c(0,1.5)) +
  ggtitle("Norway's natural population change indicators in time\nPercent of average population during the year")

dt_Population_general %>%
  filter(Indicator %in% c("Deaths", "Live births")) %>%
  group_by(Indicator, Year, SEX) %>% summarize(Value = sum(Value, na.rm = T)) %>%
  merge(dt_Population_general %>% filter(Indicator == "Average population") %>% 
          group_by(Year, SEX) %>% summarize(Pop = sum(Value, na.rm = T)), by = c("Year", "SEX")) %>%
  mutate(Value = round(Value/Pop*100, 2)) %>% 
  dcast(Year + SEX ~ Indicator, fun.aggregate = sum, value.var = "Value") %>%
  mutate(`Natural Change` = `Live births` - Deaths) %>% melt(id = c("Year", "SEX")) %>%
  setNames(c("Year", "Sex", "Indicator", "Share")) %>% return %>%
  ggplot(aes(x = Year, y = Share, color = Indicator)) + geom_line() + geom_point() + facet_grid(. ~ Sex) + 
  ggtitle("Natural change of Norway's population by sex in time\nPercent of average population during the year")

tmp_Population_General %>% filter(Indicator %in% c("Net migration", "Total population change", "Natural change")) %>%
  ggplot(aes(x = Year, y = Value, color = Indicator)) + geom_line() + geom_point() + ylim(c(0,1.5)) +
  ggtitle("Norway's migration and overall change indicators in time\nPercent of average population during the year")

```

These graphs and table were supposed to give general impression on the influence of different factors on the change of Norway's population. Preliminary conslusions are as follows:

1. Norway is constantly demonstating positive natural change of population (for the last 15 years). Death rate is steadily decreasing, while natality rate has slower decrease, which causes slow increase of natural change rate.

2. Major influence on total population change is cause by net migration. Since 2007, net migration is significantly higher than natural change (which is quite stable), so total population change is practically shadowing fluctuation of net migration.

3. Males demonstate slightly lower share of deaths and higher level of births, which results in higher positive level of natural population change. Also, this explains the change in the index of masculinity in the section above.

Further sections will address these components of population change in detail.

## Fertility

First of all, let's review some basic fertility indicators of Norway's population and their change in time:

```{r fertility_general, fig.align='center'}
dt_Fertility %>% filter(Year %% 5 == 0 | Year > 2010) %>% 
  dcast(Indicator ~ Year, fun.aggregate = sum, value.var = "Value")

dt_Fertility %>% 
  filter(Indicator %in% c("Mean age of women at birth of first child", "Mean age of women at childbirth")) %>%
  ggplot(aes(x = Year, y = Value, color = Indicator)) + geom_line() + geom_point() + ylim(c(20, 32)) +
  theme(legend.position = "bottom", legend.direction="vertical") + ylab("Age") +
  ggtitle("Mean age of women at childbirth in Norway")

dt_Fertility %>% 
  filter(Indicator == "Total fertility rate") %>%
  ggplot(aes(x = Year, y = Value)) + geom_line() + geom_point() + ylim(c(1.5, 2)) +
  ylab("Fertility Rate") + ggtitle("Total fertility rate in Norway\nwith linear regression fit") + 
  stat_smooth(method = "lm")

dt_Fertility %>% 
  filter(Indicator %in% c("Percentage first order live births", "Proportion of live births outside marriage") & Year != 2014) %>%
  ggplot(aes(x = Year, y = Value, color = Indicator)) + geom_line() + geom_point() + ylim(c(40, 60)) +
  theme(legend.position = "bottom", legend.direction="vertical") + ylab("Percent") +
  ggtitle("Other childbirth indicators in Norway")
```

We can make the following conclusions from the graphs and table:

1. Mean age of women at childbirth is steadily increasing, which is in line with the aging of population. This trend is present in both all childbirth and birth of firts child.

2. Total fertility rate is fluctiacting for the last 15 years with no definite upward or downward trend visible. Fitted linear regression shows slight increase, but the 95% confidence interval is quite wide to make some data-based forecast. Regarding the value of total rertility rate, it's always below recommended `2.3` for the stable population reproduction.

3. Proportion of live births outside marriage is quite high and especially drastic growth was during 2003-2008 from `50%` to `55%`. This one of the new trends in Western countries.

4. Percentage of first order live births is increasing, which means that average number of children per family is lowering, but number of families should increasing. Although, it can be connected with the increasing trend of propotion of births outside of marriage.

Next step will be to look at the sex ratio of newborns and distribution of age of mothers:

```{r ferility_age_sex, fig.align='center'}
dt_Fertility_Age_Sex %>%
  filter(Year %in% c(2007,2010, 2013) & !(AGE %in% c("[10,15)", "[50,100)"))) %>%
  ggplot(aes(x = AGE, y = Count)) + facet_grid(Year ~ Sex) +
  geom_bar(stat = "identity") + ylab("Count of births") + xlab("Mother's age group") +
  ggtitle("Birth in Norway by child's sex and mother's age")

dt_Fertility_Age_Sex %>%
  filter(Year %in% c(2007,2010, 2013) & !(AGE %in% c("[10,15)", "[50,100)"))) %>%
  mutate(Year = factor(Year)) %>%
  ggplot(aes(x = AGE, y = Count, color = Year)) + facet_grid(. ~ Sex) +
  geom_point() + ylab("Count of births") + xlab("Mother's age group") +
  ggtitle("Birth in Norway by child's sex and mother's age") +
  theme(legend.position = "bottom", legend.direction="horizontal")

dt_Fertility_Age_Sex %>%
  group_by(Year, Sex) %>% summarize(Pop = sum(Count, na.rm = T)) %>%
  dcast(Year ~ Sex, fun.aggregate = sum, value.var = "Pop") %>% 
  mutate(Im = M/F) %>% 
  ggplot(aes(x = Year, y = Im)) + geom_line() + geom_point() +
  geom_hline(yintercept = 1, linetype = "longdash", size = .3) +
  ggtitle("Childbirth index of masculinity in Norway\nwith fitted linear regression model") + 
  ylab("Index of Masculinity") + ylim(c(.95, 1.1)) +
  stat_smooth(method = "lm", se = F)
```

From the graphs above we can make the following conclusions:

1. First 2 graphs show that children are mainly born by women in age of 25-30 years. This distribution is similar for females and males and is stable in time.

2. Index of masculinity of the newborn was quite stable in the last 7 years with average around `1.055`. This value will be later used for population projection calculation.

And final step will be analysis of annual fertility rates by women's age. This will be one more input into population projection's calculations later on:

```{r ferility_annual, fig.align='center'}
dt_Fertility_Rate %>% filter(Year %in% c(2000, 2005, 2010, 2014)) %>%
  mutate(Year = factor(Year)) %>%
  ggplot(aes(x = Age, y = Fertility_Rate, color = Year)) +
  geom_line() + ylab("Fertility Rate") +
  theme(legend.position = "bottom", legend.direction="horizontal") +
  ggtitle("Annual fertility rate in Norway by women's age")
```

From this graph we see the following:

* High fertility rate (above `0.1`) is for women at age 25-33, similar to previous graphs.
* Mode fertility rate is concentrated at the age of 28-32.
* Distribution is moving to the right (the whole shape and mode) with time, which is aligned with increase of mean mother's age at the childbirth and general aging of the population

Overall, we can see quite a stable situation in the fertility with patterns of population aging.

## Mortality

First important indicator of mortality, which should have been analysed in fertility section, is infant mortality rate:

```{r infant_mortality, fig.align='center'}
tmp_Mortality_Rate <- dt_Death_Age %>% 
  merge(dt_Population_Age_Sex, by = c("Year", "Sex", "Age")) %>%
  mutate(`Mortality Rate` = Deaths/Population)

tmp_Mortality_Rate %>%
  filter(Age == 0) %>% 
  ggplot(aes(x = Year, y = `Mortality Rate`, color = Sex)) +
  geom_point() + geom_line() + ylim(c(0, .005)) + ylab("Infant Mortality Rate") +
  stat_smooth(method = "lm", se = F, linetype = "longdash") +
  ggtitle("Infant mortality rate in Norway by sex\nwith fitted linear regression model")

tmp_Mortality_Rate %>%
  filter(Year %in% c(2000, 2005, 2010, 2014) & Age > 0 & Age <= 40) %>% 
  mutate(Year = factor(Year), `Age Group` = Age - Age %% 5) %>%
  group_by(Year, Sex, `Age Group`) %>% summarize(`Mortality Rate` = sum(Deaths)/sum(Population)) %>%
  ggplot(aes(x = `Age Group`, y = `Mortality Rate`, color = Year)) +
  theme(legend.position = "bottom", legend.direction="horizontal") +
  geom_line() + facet_grid(. ~ Sex) + ggtitle("Mortality rate by age and sex\nfor population of age 1-40")

tmp_Mortality_Rate %>%
  filter(Year %in% c(2000, 2005, 2010, 2014) & Age >= 40 & Age <= 70) %>% 
  mutate(Year = factor(Year), `Age Group` = Age - Age %% 5) %>%
  group_by(Year, Sex, `Age Group`) %>% summarize(`Mortality Rate` = sum(Deaths)/sum(Population)) %>%
  ggplot(aes(x = `Age Group`, y = `Mortality Rate`, color = Year)) +
  theme(legend.position = "bottom", legend.direction="horizontal") +
  geom_line() + facet_grid(. ~ Sex) + ggtitle("Mortality rate by age and sex\nfor population of age 40-70")

tmp_Mortality_Rate %>%
  filter(Year %in% c(2000, 2005, 2010, 2014) & Age >= 70) %>% 
  mutate(Year = factor(Year), `Age Group` = Age - Age %% 5) %>%
  group_by(Year, Sex, `Age Group`) %>% summarize(`Mortality Rate` = sum(Deaths)/sum(Population)) %>%
  ggplot(aes(x = `Age Group`, y = `Mortality Rate`, color = Sex)) +
  theme(legend.position = "bottom", legend.direction="horizontal") +
  geom_line() + facet_wrap( ~ Year) + ggtitle("Mortality rate by age and sex\nfor population of age 70+")

tmp_Mortality_Rate %>%
  filter(Year %in% c(2000, 2014)) %>% mutate(Year = factor(Year), `Age Group` = Age - Age %% 5) %>%
  group_by(Year, Sex, `Age Group`) %>% summarize(Deaths = sum(Deaths)) %>%
  ggplot(aes(x = `Age Group`, y = Deaths)) + geom_bar(stat = "identity") +
  facet_grid(Year ~ Sex) + ggtitle("Death in Norway by sex and 5-year age groups")
```

Following conslusions can be done from the graphs above:

1. Infant mortality rate is decreasing in the last 15 years for both females and males with same speed. Also, infant mortality for males is usually higher, than for the females.

2. Mortality rate is higher for males than for females at any age.

3. Mortality rate is decreasing with time for any age. It can be noticed on second and third graphs that lines for later years are always lower.

4. Distribution of deaths by age is moving to the right and lowering with time, which means that average life expectancy is increasing. Trend is similar for both males and females.

Mortality rates by age and sex were calculated from Eurostat data on number of deaths and data on population structure by age and sex. These values will be used to calculate life table and population projection.

*Note: 5-year age groups on the graphs are marked with single integer instead of range description (`0,5,10` instead of `0-4,5-9,10-14`). That single integer indicates the first year of age group, for example: `0` means group `[0,5)`, `5` - `[5,10)`, `10` - `[10,15)`. This notation will be also used in the next sections.*

## Migration

Migration is not a part of natural change of population, but, as we've seen above, it was the biggest part of total population change in the last 10 years. Analysis of migration will be similar to mortality analysis: distribution by age and migration rates. Unfortunately, detailed data for such kind of analysis was available 

```{r migration, fig.align='center'}
tmp_Migration_Rate <- dt_Migration %>%
  merge(dt_Population_Age_Sex, by = c("Year", "Sex", "Age")) %>%
  mutate(Year = factor(Year))

tmp_Migration_Rate %>%
  mutate(`Age Group` = Age - Age %% 5) %>% group_by(`Age Group`, Sex, Year) %>%
  summarize(Immigration = sum(Immigration)/sum(Population), Emigration = sum(Emigration)/sum(Population),
         Net_Migration = Immigration - Emigration) %>%
  melt(id = c("Year", "Sex", "Age Group")) %>% filter(variable != "Population") %>%
  setNames(c("Year", "Sex", "Age Group", "Indicator", "Value")) %>%
  ggplot(aes(x = `Age Group`, y = Value, color = Indicator)) + geom_line() +
  geom_point() + facet_grid(Year ~ Sex) + ylab("Migration Rate") + 
  ggtitle("Migration rates in Norway by sex and 5-year age groups") +
  theme(legend.position = "bottom", legend.direction="horizontal")


tmp_Migration_Rate %>%
  mutate(`Age Group` = Age - Age %% 5) %>% group_by(`Age Group`, Sex, Year) %>%
  summarize(Immigration = sum(Immigration)/sum(Population), Emigration = sum(Emigration)/sum(Population),
         Net_Migration = Immigration - Emigration) %>%
  melt(id = c("Year", "Sex", "Age Group")) %>% filter(variable != "Population") %>%
  setNames(c("Year", "Sex", "Age Group", "Indicator", "Value")) %>%
  ggplot(aes(x = `Age Group`, y = Value, color = Sex)) + geom_line() +
  geom_point() + facet_grid(Indicator ~ Year) + ylab("Migration Rate") + 
  ggtitle("Migration rates in Norway by sex and 5-year age groups") +
  theme(legend.position = "bottom", legend.direction="horizontal")

tmp_Migration_Rate %>%
  mutate(`Age Group` = Age - Age %% 5) %>% group_by(`Age Group`, Sex) %>%
  summarize(Immigration = sum(Immigration/2), Emigration = sum(Emigration/2), Net_Migration = Immigration - Emigration) %>%
  melt(id = c("Sex", "Age Group")) %>% filter(variable != "Population") %>%
  setNames(c("Sex", "Age Group", "Indicator", "Value")) %>%
  ggplot(aes(x = `Age Group`, y = Value)) + geom_bar(stat = "identity") +
  facet_grid(Sex ~ Indicator) + ylab("# of people") + 
  ggtitle("Migration in Norway by sex and 5-year age groups") +
  theme(legend.position = "bottom", legend.direction="horizontal")
```

Following conclusions can be made from the migration graphs:

1. In general, emigration and immigration have similar behavioural pattern by age groups. Although, males' emigration significantly heavier right tale: females' emigration is dropping to zero after age of 55, but males are still quite actively engaged in emigration. On the other hand, tend to emigrate more than males at the age of 20-24.

2. Mode of both emigration and immigration is the `25-29` age group, but `20-24` and `30-34` also demonstrate high levels of migration activity.


# Life Tables

## Calculation

Life tables for females and males will be prepared based on data, described and visualized in the sections above: 

* Population by age and sex, deaths by age and sex
* Data from years 2010-2015 will be taken into account and averaged in the final table
* Age horizon is from 0 to 100

First, let's calculated age-specific mortality rate by sex:

```{r life_mortality}
life_Mortality <- dt_Death_Age %>% 
  filter(Year >= 2010) %>%
  merge(dt_Population_Age_Sex, by = c("Year", "Sex", "Age")) %>%
  group_by(Sex, Age) %>% 
  summarize(`Mortality Rate` = sum(Deaths, na.rm = T)/(sum(Population, na.rm = T)-sum(Deaths, na.rm = T)/2))

life_Mortality %>% mutate(`Mortality Rate` = round(`Mortality Rate`, 4)) %>%
  dcast(Age ~ Sex, value.var = "Mortality Rate")
```

Now, based on these age-specific mortality rates, will be constructed the whole life table:

```{r life_table, fig.align='center'}
life_Males <- life_Mortality %>% filter(Sex == "M") %>% arrange(Age) %>%
  mutate(qx = `Mortality Rate`, px = 1-qx, lx = cumprod(px)*100000/px,
         dx = lx * qx, Lx = lx-dx/2) %>%
  select(-`Mortality Rate`) %>% arrange(-Age) %>%
  mutate(Tx = cumsum(Lx), ex = Tx/lx) %>% arrange(Age)

cat("Life table for male population of Norway:")
life_Males %>%
  mutate(qx = round(qx,4), px = round(px,4), lx = comma(lx %>% round(0)),
         dx = round(dx,1), Lx = comma(Lx %>% round(0)), Tx = comma(Tx %>% round(0)), ex = round(ex,1)) %>%
  print(n = nrow(life_Males))

life_Females <- life_Mortality %>% filter(Sex == "F") %>% arrange(Age) %>%
  mutate(qx = `Mortality Rate`, px = 1-qx, lx = cumprod(px)*100000/px,
         dx = lx * qx, Lx = lx-dx/2) %>%
  select(-`Mortality Rate`) %>% arrange(-Age) %>%
  mutate(Tx = cumsum(Lx), ex = Tx/lx) %>% arrange(Age)

cat("Life table for female population of Norway:")
life_Females %>%
  mutate(qx = round(qx,4), px = round(px,4), lx = comma(lx %>% round(0)),
         dx = round(dx,1), Lx = comma(Lx %>% round(0)), Tx = comma(Tx %>% round(0)), ex = round(ex,1)) %>% 
  print(n = nrow(life_Females))
```

## Summary

```{r life_tbl_graph, fig.align='center'}
life_Females %>% rbind(life_Males) %>%
  ggplot(aes(x = Age, y = lx, color = Sex)) + geom_line() +
  geom_hline(yintercept = 50000, linetype = "longdash") +
  ggtitle("Development of cohort's population with age\nBased on calculated life tables for Norway")
```

Results from the life tables:

1. Life expectancy at birth is `r max(life_Males$ex) %>% round(1)` years for males and `r max(life_Females$ex) %>% round(1)` for females, which confirms our previous suspicious about life expectancy of females being higher than of males.
2. Median life lenght is `r life_Males$Age[life_Males$lx >= 50000] %>% max()` for males and `r life_Females$Age[life_Females$lx >= 50000] %>% max()` for females, which confirms again longer live of females.

3. Due to higher mortality rates males' cohort's population is decreasing faster than females'.

# Projections
## Calculation
In calculation of projections we will include the following parameters:

* Population size by sex and age at the beginning of 2015
* Age-specific mortality rates by sex (same as for life tables)
* Age-specific net migration rates by sex
* Age-specific fertility rates (for age from 15 to 49)
* Average index of masculinity at childbirth

```{r proj_load, echo=FALSE}
load('D:/OneDrive/VSE/II/Economic Demography I/Project Norway/Output/Projections.RData')
```

```{r projections_false, fig.align='center', cache = F, eval=FALSE}
proj_parameter <- list(pop_change = tmp_Migration_Rate %>% group_by(Age, Sex) %>%
                         summarize(Net.Migration = (sum(Immigration)-sum(Emigration))/sum(Population)) %>%
                         merge(life_Mortality, by = c("Age", "Sex")) %>% 
                         mutate(Net.Change = Net.Migration - `Mortality Rate`) %>%
                         select(Age, Sex, Net.Change),
                       fertility = dt_Fertility_Rate %>% 
                         group_by(Age) %>% 
                         summarize(Fertility_Rate = mean(Fertility_Rate, na.rm = T)) %>%
                         mutate(Sex = factor("F", levels = c("F", "M"))),
                       males_share = dt_Fertility_Age_Sex %>% group_by(Sex) %>% 
                         summarize(Pop = sum(Count, na.rm = T)) %>%
                         mutate(Ratio = Pop/sum(Pop)) %>% `[`(2, "Ratio") %>% max())

proj_result <- dt_Population_Age_Sex %>% filter(Year == 2015)

for (i in (2016:2100))
  proj_result <- proj_result %>% filter(Year == i-1) %>%
    merge(proj_parameter$pop_change, by = c("Age", "Sex")) %>%
    mutate(Population = Population * (1 + Net.Change), Year = i, Age = pmin(100, Age+1)) %>%
    group_by(Age, Year, Sex) %>% summarize(Population = sum(Population) %>% round(0)) %>%
    rbind(data.frame(c(0,0), rep(i, 2), factor(c("M","F")), ((proj_result %>% filter(Year == i-1) %>%
    merge(proj_parameter$fertility, by = c("Age", "Sex")) %>%
    mutate(Population = Population * Fertility_Rate) %>%
    `[`(,"Population") %>% sum())*c(proj_parameter$males_share,1-proj_parameter$males_share)) %>% round(0)) %>%
      setNames(c("Age", "Year", "Sex", "Population"))) %>%
    rbind(proj_result)
optimistic_scenario <- list(proj_parameter = proj_parameter, proj_result = proj_result)
```

```{r optimistic, fig.align='center'}
optimistic_scenario$proj_result %>% group_by(Year) %>% summarize(Population = sum(Population)) %>%
  ggplot(aes(x = Year, y = Population)) + geom_line() +
  scale_y_continuous(limits = c(0, 1.2*10^7), labels = comma) +
  ggtitle("Projection of Norway's population till 2100\nOptimistic scenario")

optimistic_scenario$proj_result %>% group_by(Year, Sex) %>% summarize(Population = sum(Population)) %>%
  ggplot(aes(x = Year, y = Population, color = Sex)) + geom_line() +
  scale_y_continuous(limits = c(0, .6*10^7), labels = comma) +
  ggtitle("Projection of Norway's population by sex till 2100\nOptimistic scenario")

optimistic_scenario$proj_result %>% 
  filter(Year == 2100) %>% group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = 1, Cstep = 5, AxisFM = 'd', Cgap = .1,
          main = "Pyramid of Norway's population in 2100\nOptimistic scenario")

```

## Scenarios

As you can see from this projection, population of Norway will continue steady growth and reach `11` mln people in 2100. Also, we notice a gap between male and female population size, which is constantly increasing. This is caused by the net migration parameter. This parameter is quite high because in 2010-s immigration to Norway was high, but we cannot assume that such level will stay till 2100. Therefore, this scenarion is called optimistic and we will calculate 2 more scenarios: pessimistic (half of current net migration) and no-migration scenario.

```{r proj_scenario, fig.align='center', cache=F, eval=FALSE}
# Pessimistic scenario
proj_parameter$pop_change <- tmp_Migration_Rate %>% group_by(Age, Sex) %>%
                         summarize(Net.Migration = (sum(Immigration)-sum(Emigration))/sum(Population)/2) %>%
                         merge(life_Mortality, by = c("Age", "Sex")) %>% 
                         mutate(Net.Change = Net.Migration - `Mortality Rate`) %>%
                         select(Age, Sex, Net.Change)
proj_result <- dt_Population_Age_Sex %>% filter(Year == 2015)
for (i in (2016:2100))
  proj_result <- proj_result %>% filter(Year == i-1) %>%
    merge(proj_parameter$pop_change, by = c("Age", "Sex")) %>%
    mutate(Population = Population * (1 + Net.Change), Year = i, Age = pmin(100, Age+1)) %>%
    group_by(Age, Year, Sex) %>% summarize(Population = sum(Population) %>% round(0)) %>%
    rbind(data.frame(c(0,0), rep(i, 2), factor(c("M","F")), ((proj_result %>% filter(Year == i-1) %>%
    merge(proj_parameter$fertility, by = c("Age", "Sex")) %>%
    mutate(Population = Population * Fertility_Rate) %>%
    `[`(,"Population") %>% sum())*c(proj_parameter$males_share,1-proj_parameter$males_share)) %>% round(0)) %>%
      setNames(c("Age", "Year", "Sex", "Population"))) %>%
    rbind(proj_result)

pessimistic_scenario <- list(proj_parameter = proj_parameter, proj_result = proj_result)

# No-migration scenario
proj_parameter$pop_change <- life_Mortality %>% setNames(c("Sex","Age","Net.Change")) %>%
  mutate(Net.Change = -Net.Change)
proj_result <- dt_Population_Age_Sex %>% filter(Year == 2015)
for (i in (2016:2100))
  proj_result <- proj_result %>% filter(Year == i-1) %>%
    merge(proj_parameter$pop_change, by = c("Age", "Sex")) %>%
    mutate(Population = Population * (1 + Net.Change), Year = i, Age = pmin(100, Age+1)) %>%
    group_by(Age, Year, Sex) %>% summarize(Population = sum(Population) %>% round(0)) %>%
    rbind(data.frame(c(0,0), rep(i, 2), factor(c("M","F")), ((proj_result %>% filter(Year == i-1) %>%
    merge(proj_parameter$fertility, by = c("Age", "Sex")) %>%
    mutate(Population = Population * Fertility_Rate) %>%
    `[`(,"Population") %>% sum())*c(proj_parameter$males_share,1-proj_parameter$males_share)) %>% round(0)) %>%
      setNames(c("Age", "Year", "Sex", "Population"))) %>%
    rbind(proj_result)

no.migration_scenario <- list(proj_parameter = proj_parameter, proj_result = proj_result)

proj_result_total <- optimistic_scenario$proj_result %>% mutate(Scenario = "Optimistic") %>%
  rbind(pessimistic_scenario$proj_result %>% mutate(Scenario = "Pessimistic")) %>%
  rbind(no.migration_scenario$proj_result %>% mutate(Scenario = "No-migration")) %>%
  mutate(Scenario = factor(Scenario, levels = c("Optimistic", "Pessimistic", "No-migration"), ordered = T))
```

Now we will compare the results of different scenarios by the following metrics:

* Population size in time
* Pyramid structure (every 30 years)
* Economic generations' indeces

First will be general population size:

```{r scen_size, fig.align='center'}
proj_result_total %>%
  group_by(Scenario, Year) %>% summarize(Population = sum(Population)) %>%
  ggplot(aes(x = Year, y = Population, color = Scenario)) + geom_line() +
  scale_y_continuous(limits = c(0, 1.2*10^7), labels = comma) +
  ggtitle("Projection of Norway's population till 2100\nAll scenarios") +
  theme(legend.position = "bottom", legend.direction="horizontal")
```

Second - pyramids:

```{r proj_pyramids, fig.align='center', fig.height=4}
proj_result_total %>% 
  filter(Year == 2015 & Scenario == "Optimistic") %>% 
  group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = .7, Cstep = 10, AxisFM = 'd', Cgap = .1, Laxis = 0:4*20000,
          main = "Pyramid of Norway's population in 2015\nReal situation")

cat("Optimistic scenario")
# Optimistic
proj_result_total %>% 
  filter(Year == 2045 & Scenario == "Optimistic") %>% 
  group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = .7, Cstep = 10, AxisFM = 'd', Cgap = .1, Laxis = 0:4*20000,
          main = "Pyramid of Norway's population in 2045\nOptimistic scenario")
proj_result_total %>% 
  filter(Year == 2075 & Scenario == "Optimistic") %>% 
  group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = .7, Cstep = 10, AxisFM = 'd', Cgap = .1, Laxis = 0:4*20000,
          main = "Pyramid of Norway's population in 2075\nOptimistic scenario")
proj_result_total %>% 
  filter(Year == 2100 & Scenario == "Optimistic") %>% 
  group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = .7, Cstep = 10, AxisFM = 'd', Cgap = .1, Laxis = 0:4*20000,
          main = "Pyramid of Norway's population in 2100\nOptimistic scenario")

# Pessimistic
cat("Pessimistic scenario")
proj_result_total %>% 
  filter(Year == 2045 & Scenario == "Pessimistic") %>% 
  group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = .7, Cstep = 10, AxisFM = 'd', Cgap = .1, Laxis = 0:4*20000,
          main = "Pyramid of Norway's population in 2045\nPessimistic scenario")
proj_result_total %>% 
  filter(Year == 2075 & Scenario == "Pessimistic") %>% 
  group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = .7, Cstep = 10, AxisFM = 'd', Cgap = .1, Laxis = 0:4*20000,
          main = "Pyramid of Norway's population in 2075\nPessimistic scenario")
proj_result_total %>% 
  filter(Year == 2100 & Scenario == "Pessimistic") %>% 
  group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = .7, Cstep = 10, AxisFM = 'd', Cgap = .1, Laxis = 0:4*20000,
          main = "Pyramid of Norway's population in 2100\nPessimistic scenario")

# No-migration
cat("No-migration scenario")
proj_result_total %>% 
  filter(Year == 2045 & Scenario == "No-migration") %>% 
  group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = .7, Cstep = 10, AxisFM = 'd', Cgap = .1, Laxis = 0:4*20000,
          main = "Pyramid of Norway's population in 2045\nNo-migration scenario")
proj_result_total %>% 
  filter(Year == 2075 & Scenario == "No-migration") %>% 
  group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = .7, Cstep = 10, AxisFM = 'd', Cgap = .1, Laxis = 0:4*20000,
          main = "Pyramid of Norway's population in 2075\nNo-migration scenario")
proj_result_total %>% 
  filter(Year == 2100 & Scenario == "No-migration") %>% 
  group_by(Age, Sex) %>% summarise(value = sum(Population, na.rm = T)) %>%
  dcast(Age ~ Sex, fun.aggregate = sum, value.var = "value") %>% select(M, F, Age) %>%
  pyramid(Csize = .7, Cstep = 10, AxisFM = 'd', Cgap = .1, Laxis = 0:4*20000,
          main = "Pyramid of Norway's population in 2100\nNo-migration scenario")

```

And, finally, structure of economic generations:

```{r proj_gen, fig.align='center'}
proj_gen <- proj_result_total %>% 
  mutate(Generation = cut(Age, breaks = c(0,20, 65, 100), include.lowest = T, right = F, labels = c("I","II","III"))) %>%
  group_by(Year, Scenario, Generation) %>% summarise(Population = sum(Population)) %>%
  dcast(Year + Scenario ~ Generation, value.var = "Population") %>%
  mutate(Seniority = III/I, OADR = III/II, JADR = I/II, TDR = (I+III)/II) %>%
  select(-c(I,II,III)) %>% melt(id = c("Year", "Scenario")) %>%
  setNames(c("Year","Scenario","Indicator","Value")) %>%
  mutate(Value = round(Value,2))
  
proj_gen %>%
  filter(Year %in% c(2015, 2045, 2075, 2100)) %>%
  dcast(Year + Scenario ~ Indicator, value.var = "Value") %>%
  arrange(Scenario)

proj_gen %>%
  ggplot(aes(x = Year, y = Value, color = Scenario)) +
  geom_line() + facet_grid(Indicator ~ ., scales = "free_y") +
  theme(legend.position = "bottom", legend.direction="horizontal")
```

## Summary

Here are the conclusions regarding our population projections:

1. **General**: You can see a stabilization of indeces and smoothing of population pyramid with time, which means that population structure is converging after some amoint of years (~ after year 2040 for indeces). This certainly won't happen in the real world because parameters, on which projections were calculated will always change, with the random deviations that cannot be projected. Also, interesting is that JADR is independent of scenario, which means that it's independent of the net migration.

2. **Optimistic scenario**: This scenario shows quick and steady growth, which is quite feasible as we've seen on data from 1960 to 2015. On the other hand, by it's projection index of masculinity will be constantly more than 1, which will cause icreasing gap between number of males and females. This is caused by the current (2013 and 2014) net migration structure and it won't be the same for 50 years. Regarding the pyramid structure, this scenario provides us with the progressive (and `0.88` index of seniority confirms it) type of population for Norway.

3. **Pessimistic scenario**: According to this scenario, Norway's population is slowly growing without significant change of the pyramid structure. This will keep Norway's population in stationary type with index of seniority around value of `1`. 

4. **No-migration scenario**: This scenarios is quite teoretical because in realiry net migration has bigger influence on the population of Norway than the natural change of population. Nevertheless, this option brings us slow decrease and aging of population: population pyramid is of regressive type with index of seniority equal to `1.13`.

All in all, my personal feeling is that real situation will be somewhere near Pessimistic scenario with elements of aging and regressive type of population.

# Conclusions

Throughout the analysis, Norway showed itself as typical Western developed country with usual trends: increase in life expectancy and aging of population, positive net migration, big share of childbirths outside the marriage.

Overall, population of Norway seems to be quite "healthy" (structural- and tendency-wise) and projection scenarios show confidence in proper developments of country's population.

# Appendix
## Used libraries

Here's the list of libraries used during this assignment:

```{r libraries used, eval=FALSE, echo=TRUE}
library(dplyr)      # Work with datasets: filter, group, summarize
library(reshape2)   # Transformation of datasets: wide-to-long format and vice versa
library(pyramid)    # Visualization of demography pyramid
library(ggplot2)    # Building graphs
library(scales)     # Number formatting
```

## Explanation of code parts

`%>%` element is called chaining operator and is a part of *dplyr* package. This operator is handing element on the left to the function on the right as the first argument. It helps to make complicated nested formulas easier to comprehend:

```{r chain_example, eval=FALSE}
# Simple example
    filter(dataset, field == "value") 
        # is equal to
    dataset %>% filter(field == "value")

# More complex example
    summarize(group_by(filter(dataset, field == "value"), group_field), function(value_field))
        # is equal to
    dataset %>% filter(field == "value") %>% group_by(group_field) %>% summarize(function(value_field))
```

As you can see from the second example, chaining operator makes your code much more easier to read. That's why it's used throughout the paper.

## Source data

Following datasets from the [Eurostat](http://ec.europa.eu/eurostat/web/population-demography-migration-projections/overview) were used in this assignment:

* dt_Population_General: some general indicators for Norway for years 2000-2014

* dt_Population_Age_Sex: Norway's population by age and sex from 1960 to 2015

* dt_Education: Norway's population by age, sex and education level from 2007 to 2014

* dt_Marital: Norway's population by age, sex and marital status from 2000 to 2014

* dt_Marriage_Age: Marriages in Norway by age groups and sex from 2007 to 2014

* dt_Marriage_PrevStatus: Marriages in Norway by sex and previous marital status from 2007 to 2014

* dt_Divorce: Divorce indicators in Norway 

* dt_Fertility: Fertility indicators from 2000 to 2014

* dt_Fertility_Rate: Annual fertility rates for women in Norway by age from 2000 to 2014

* dt_Fertility_Age_Sex: Births by sex and mother's age in Norway from 2007 to 2013

* dt_Death_Age: Deaths in Norway by age and sex from 2007 to 2014

* dt_Migration: Immigration, Emigration and Net Migration by age and sex in Norway for 2013 and 2014

Full tables are attached in the archive. Also, RData file `Eurostat.RData` contains all those source tables after import to R. 

Here are 10 sample rows for each of the tables:

**dt_Population_general**

```{r}
dt_Population_general %>% head(10)
```

**dt_Population_Age_Sex**

```{r}
dt_Population_Age_Sex %>% head(10)
```

**dt_Education**

```{r}
dt_Education %>% head(10)
```

**dt_Marital**

```{r}
dt_Marital %>% head(10)
```

**dt_Marriage_Age**

```{r}
dt_Marriage_Age %>% head(10)
```

**dt_Marriage_PrevStatus**

```{r}
dt_Marriage_PrevStatus %>% head(10)
```

**dt_Divorce**

```{r}
dt_Divorce %>% head(10)
```

**dt_Fertility**

```{r}
dt_Fertility %>% head(10)
```

**dt_Fertility_Rate**

```{r}
dt_Fertility_Rate %>% head(10)
```

**dt_Fertility_Age_Sex**

```{r}
dt_Fertility_Age_Sex %>% head(10)
```

**dt_Death_Age**

```{r}
dt_Death_Age %>% head(10)
```

**dt_Migration**

```{r}
dt_Migration %>% head(10)
```

